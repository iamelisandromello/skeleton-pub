name: Dynamic Lambda Deployment

on:
  pull_request:
    branches:
      - main
      - develop
      - feature/**
      - hotfix/**


jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1

    steps:
      # -------------------------------
      # üßæ CHECKOUT & NODE SETUP
      # -------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # -------------------------------
      # ‚öôÔ∏è SETUP ENVIRONMENT
      # -------------------------------
      - name: Setup Environment Variables
        run: |
          echo "PROJECT_NAME=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV

          # Define ambiente com base na branch
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ENVIRONMENT=prod" >> $GITHUB_ENV
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=preview" >> $GITHUB_ENV
          fi

      # -------------------------------
      # üì¶ DEPENDENCIES & BUILD
      # -------------------------------
      - name: Install dependencies
        run: npm install

      - name: Build TypeScript
        run: npm run build

      # -------------------------------
      # ‚öôÔ∏è SETUP ENVIRONMENT
      # -------------------------------
      - name: Setup Environment Variables
        run: echo "PROJECT_NAME=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV

      # -------------------------------
      # üìÅ PACKAGE LAMBDA FUNCTION
      # -------------------------------
      - name: Create Lambda ZIP with node_modules
        run: |
          mkdir -p lambda-package
          cp -r dist/* lambda-package/
          cp -r node_modules lambda-package/
          cp package.json lambda-package/
          cd lambda-package
          zip -r ../${{ env.PROJECT_NAME }}.zip .

      # -------------------------------
      # ‚òÅÔ∏è UPLOAD PACKAGE TO S3
      # -------------------------------
      - name: Extrair nome do bucket S3 das env vars
        id: extract_bucket
        run: |
          echo '${{ secrets.LAMBDA_ENV_VARS_JSON }}' | jq -r '.S3_BUCKET_NAME' > bucket_name.txt
          echo "S3_BUCKET_NAME=$(cat bucket_name.txt)" >> $GITHUB_ENV

      - name: Debug S3 Bucket Name
        run: |
          echo "Usando bucket: $S3_BUCKET_NAME"
        
      - name: Upload Lambda ZIP to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: aws s3 cp ${{ env.PROJECT_NAME }}.zip s3://${{ env.S3_BUCKET_NAME }}/${{ env.PROJECT_NAME }}.zip
      
      # -------------------------------
      # üõ†Ô∏è SETUP TERRAFORM
      # -------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.6
      # -------------------------------
      # üì¶ TERRAFORM INIT & WORKSPACE
      # -------------------------------
      - name: Terraform Init
        run: |
          terraform init
          terraform workspace select ${{ env.ENVIRONMENT }} || terraform workspace new ${{ env.ENVIRONMENT }}
        working-directory: terraform
        env:
          TF_WORKSPACE: ${{ env.ENVIRONMENT }}          
          TF_VAR_project_name: ${{ env.PROJECT_NAME }}
          TF_VAR_s3_bucket_name: ${{ env.S3_BUCKET_NAME }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # -------------------------------
      # üßæ GENERATE TFVARS FROM SECRETS
      # -------------------------------
      - name: Create environment JSON file for Terraform
        run: |
          printf '{"lambda_env_vars": %s}\n' '${{ secrets.LAMBDA_ENV_VARS_JSON }}' > terraform/lambda-env-vars.auto.tfvars.json

      - name: Verificar acesso ao S3
        run: aws s3 ls s3://${{ secrets.S3_BUCKET_NAME }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # -------------------------------
      # üîÑ IMPORT EXISTING RESOURCES
      # -------------------------------
      - name: Import existing AWS resources
        run: |
          set -e  # ‚õî Interrompe o script ao primeiro erro
          
          export AWS_REGION="${{ env.AWS_REGION }}"
          export PROJECT_NAME="${{ env.PROJECT_NAME }}"
          export QUEUE_NAME="${PROJECT_NAME}-queue"
          export ROLE_NAME="${PROJECT_NAME}_execution_role"
          export LOG_GROUP_NAME="/aws/lambda/${PROJECT_NAME}"
      
          echo "üì¶ Importando recursos existentes, se encontrados..."
      
          # --- Importar SQS Queue, se existir ---
          echo "üîç Verificando exist√™ncia da fila SQS '$QUEUE_NAME'..."
          QUEUE_URL=$(aws sqs get-queue-url --queue-name "$QUEUE_NAME" --region "$AWS_REGION" --query 'QueueUrl' --output text 2>/dev/null)
          if [ -n "$QUEUE_URL" ]; then
            echo "‚úÖ Fila SQS encontrada. Importando..."
            terraform import aws_sqs_queue.my_queue "$QUEUE_URL"
          else
            echo "‚ùå Fila SQS '$QUEUE_NAME' n√£o encontrada. Terraform ir√° cri√°-la no apply."
          fi
      
          # --- Importar bucket S3 (sempre existente e compartilhado) ---
          echo "‚úÖ Bucket S3 √© tratado como data source, n√£o requer import."
      
          # --- Importar IAM Role, se existir ---
            echo "üîç Verificando exist√™ncia da IAM Role '$ROLE_NAME'..."
            if aws iam get-role --role-name "$ROLE_NAME" --region "$AWS_REGION" &>/dev/null; then
              echo "‚úÖ IAM Role encontrada. Importando..."
              terraform import aws_iam_role.lambda_execution_role "$ROLE_NAME"
            else
              echo "‚ùå IAM Role '$ROLE_NAME' n√£o encontrada. Terraform ir√° cri√°-la no apply."
            fi
                
          # --- Importar CloudWatch Log Group, se existir ---
          echo "üîç Verificando exist√™ncia do CloudWatch Log Group '$LOG_GROUP_NAME'..."
          if aws logs describe-log-groups --log-group-name-prefix "$LOG_GROUP_NAME" --region "$AWS_REGION" | grep "$LOG_GROUP_NAME" &>/dev/null; then
            echo "‚úÖ Log Group encontrado. Importando..."
            terraform import aws_cloudwatch_log_group.lambda_log_group "$LOG_GROUP_NAME"
          else
            echo "‚ùå Log Group '$LOG_GROUP_NAME' n√£o encontrado. Terraform ir√° cri√°-lo no apply."
          fi
      
          # --- Importar Lambda Function, se existir ---
          echo "üîç Verificando exist√™ncia da fun√ß√£o Lambda '$PROJECT_NAME'..."
          if aws lambda get-function --function-name "$PROJECT_NAME" --region "$AWS_REGION" &>/dev/null; then
            echo "‚úÖ Fun√ß√£o Lambda encontrada. Importando..."
            terraform import aws_lambda_function.my_lambda_function "$PROJECT_NAME"
          else
            echo "‚ùå Fun√ß√£o Lambda '$PROJECT_NAME' n√£o encontrada. Terraform ir√° cri√°-la no apply."
          fi
        continue-on-error: true
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_VAR_s3_bucket_name: ${{ env.S3_BUCKET_NAME }}
          TF_VAR_project_name: ${{ env.PROJECT_NAME }}
        working-directory: terraform

      # -------------------------------
      # üîç VALIDA√á√ÉO DO TERRAFORM
      # Garante que a configura√ß√£o est√° sintaticamente correta
      # antes de prosseguir com o plano de execu√ß√£o.
      # -------------------------------
      - name: Terraform Validate
        run: terraform validate
        working-directory: terraform
        
      # -------------------------------
      # üß™ TERRAFORM PLAN & APPLY
      # -------------------------------
      - name: Terraform Plan
        run: terraform plan -input=false
        working-directory: terraform
        env:
          TF_VAR_project_name: ${{ env.PROJECT_NAME }}
          TF_VAR_s3_bucket_name: ${{ env.S3_BUCKET_NAME }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Terraform Apply
        run: terraform apply -auto-approve
        working-directory: terraform
        env:
          TF_VAR_project_name: ${{ env.PROJECT_NAME }}
          TF_VAR_s3_bucket_name: ${{ env.S3_BUCKET_NAME }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
